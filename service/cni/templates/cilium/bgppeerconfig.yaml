{{- if and .Values.cilium.bgp.enabled }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: create-bgp-peer-config
  labels:
    {{- include "cni.labels" $ | nindent 4 }}
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "5"
spec:
  template:
    spec:
      serviceAccountName: cilium-resource-creator
      restartPolicy: OnFailure
      containers:
        - name: kubectl
          image: bitnami/kubectl:latest
          command:
            - /bin/bash
            - -c
            - |
              set -e
              echo "Waiting for Cilium BGP CRDs to be available..."
              for i in {1..60}; do
                if kubectl get crd ciliumbgppeerconfigs.cilium.io >/dev/null 2>&1; then
                  echo "CRD found, creating BGPPeerConfig"
                  cat <<EOF | kubectl apply -f -
              apiVersion: cilium.io/v2alpha1
              kind: CiliumBGPPeerConfig
              metadata:
                name: bgp-peer-config
                labels:
                  {{- include "cni.labels" $ | nindent 14 }}
              spec:
                authSecretRef: {{ .Values.cilium.bgp.peer.authSecretRef }}
                ebgpMultihop: {{ .Values.cilium.bgp.peer.multiHop }}
                timers:
                  holdTimeSeconds: {{ .Values.cilium.bgp.peer.holdTimeSec }}
                  keepAliveTimeSeconds: {{ .Values.cilium.bgp.peer.keepAliveTimeSec }}
                gracefulRestart:
                  enabled: {{ .Values.cilium.bgp.peer.gracefulRestart }}
                  restartTimeSeconds: {{ .Values.cilium.bgp.peer.restartTimeSec }}
                families: {{- range .Values.cilium.bgp.peer.addressFamilies }}
                  - afi: {{ .afi }}
                    safi: {{ .safi }}
                    {{- if .advertisements }}
                    advertisements:
                      {{- toYaml .advertisements | nindent 18 }}
                    {{- end }}
                {{- end }}
              EOF
                  exit 0
                fi
                echo "Attempt $i: BGP CRD not ready, waiting 10s..."
                sleep 10
              done
              echo "Timeout waiting for BGP CRD"
              exit 1
{{- end }}
